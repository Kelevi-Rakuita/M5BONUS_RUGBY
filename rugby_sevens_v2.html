<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Rugby Sevens — MVP v2 (CSC 134)</title>
<style>
  :root{
    --bg:#0b0f1a;--panel:#101828;--mut:#7c92b2;--text:#eaf2ff;
    --acc:#5eead4;--acc2:#60a5fa;--bad:#ff8b8b;--good:#86efac;--warn:#fcd34d;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .wrap{max-width:1024px;margin:28px auto;padding:16px}
  .grid{display:grid;gap:16px;grid-template-columns:1.3fr 1fr}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
  .card{background:var(--panel);border-radius:16px;padding:16px;box-shadow:0 10px 28px rgba(0,0,0,.3)}
  h1{margin:0 0 6px;font-size:24px}
  .muted{color:var(--mut);font-size:14px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .score{display:flex;align-items:center;justify-content:space-between}
  .badg{padding:6px 10px;border-radius:999px;background:#1a2440;border:1px solid #283a66;font-size:12px}
  .pos{background:linear-gradient(90deg,var(--acc2),var(--acc));color:#08141c;font-weight:700}
  .btn{background:#1a2948;color:var(--text);border:1px solid #2a3e69;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn:hover{background:#253a67}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .field{margin:10px 0;padding:12px;background:#0a1a0f;border-radius:12px;border:1px solid #1e3b29}
  .bar{position:relative;height:16px;background:linear-gradient(90deg,#0b351f,#116b38);border-radius:999px;overflow:hidden}
  .mark{position:absolute;top:0;bottom:0;width:4px;background:#fff;box-shadow:0 0 6px #fff}
  .ticks{display:flex;justify-content:space-between;font-size:12px;color:#a6d5bf;margin-top:6px}
  .log{height:420px;overflow:auto;background:#0e1726;border-radius:12px;padding:12px;border:1px solid #1f2a47}
  .log p{margin:0 0 8px}
  .good{color:var(--good)} .bad{color:var(--bad)} .warn{color:var(--warn)}
  .footer{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:8px}
  select{background:#15223b;color:var(--text);border:1px solid #2a3e69;padding:8px;border-radius:10px}
  .convert{display:none;margin-top:12px;padding:12px;background:#0f1f35;border-radius:12px;border:1px solid #274170}
  .meter{position:relative;height:18px;background:#113258;border-radius:8px;overflow:hidden}
  .needle{position:absolute;top:0;bottom:0;width:6px;background:#fff}
  .sweet{position:absolute;top:0;bottom:0;background:rgba(94,234,212,.35)}
  .help{font-size:12px;color:var(--mut)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Rugby Sevens — MVP v2 <span class="muted">CSC 134</span></h1>
  <div class="grid">
    <div class="card">
      <div class="score">
        <div>
          <div><strong id="teamAName">You</strong> <span id="scoreA">0</span> — <span id="scoreB">0</span> <strong id="teamBName">Opp</strong></div>
          <div class="muted">Turns: <span id="turns">14</span> • Half: <span id="half">1</span> • Momentum: <span id="mom">0</span> • Stamina: <span id="sta">100</span>%</div>
        </div>
        <div class="row">
          <span class="badg pos" id="pos">Your ball</span>
          <span class="badg" id="posLbl">Midfield</span>
        </div>
      </div>

      <div class="row" style="margin:10px 0">
        <label class="help">Team:</label>
        <select id="teamSel">
          <option value="Fiji">Fiji</option>
          <option value="NZ">New Zealand</option>
          <option value="Samoa">Samoa</option>
          <option value="USA">USA</option>
          <option value="England">England</option>
        </select>
        <label class="help">Difficulty:</label>
        <select id="diffSel">
          <option value="casual">Casual</option>
          <option value="standard" selected>Standard</option>
          <option value="elite">Elite</option>
        </select>
        <button class="btn" id="btnStart">Kickoff</button>
        <button class="btn" id="btnNew">Reset</button>
      </div>

      <div class="field">
        <div class="bar"><div class="mark" id="marker" style="left:50%"></div></div>
        <div class="ticks"><span>0m</span><span>25</span><span>50</span><span>75</span><span>Try (100)</span></div>
      </div>

      <div class="row" style="margin-bottom:8px">
        <button class="btn" id="btnCrash" title="Low risk, steady meters. Small knock-on risk.">Crash</button>
        <button class="btn" id="btnSwitch" title="Wider pass pattern. Higher meters, higher forward-pass risk.">Switch Pass</button>
        <button class="btn" id="btnChip" title="Chip to space; chance to regather, otherwise give up ball but gain territory.">Chip & Chase</button>
        <button class="btn" id="btnBox" title="Box kick to touch for territory; lineout gives opp ball but stops their quick attack.">Box Kick to Touch</button>
        <button class="btn" id="btnOffload" title="Context: after Crash/Switch if meters ≥10 — gamble extra meters with turnover risk.">Offload</button>
      </div>

      <div class="convert" id="convertBox">
        <p><strong>Conversion:</strong> Stop the needle in the green to add <strong>+2</strong>.</p>
        <div class="meter" id="meter" style="margin-bottom:8px;">
          <div class="sweet" id="sweet"></div>
          <div class="needle" id="needle"></div>
        </div>
        <div class="row">
          <button class="btn" id="btnKickNow">Kick!</button>
        </div>
      </div>

      <div class="footer">
        <small class="help">Tip: Stamina affects meters & handling. Momentum shifts outcomes. Box Kick stops momentum but gains territory.</small>
      </div>
    </div>

    <div class="card">
      <div class="log" id="log"></div>
    </div>
  </div>
</div>

<script>
(function(){
  // --------- State ---------
  const S = {
    teamA:"You", teamB:"Opp",
    diff:"standard",
    scoreA:0, scoreB:0,
    turns:14, half:1,
    meters:50,           // 0..100 toward Opp try
    poss:'A',            // 'A' you, 'B' opp
    momentum:0,          // -2..+2, for A
    stamina:100,         // 0..100, for A
    lock:false,
    canOffload:false,
    pendingConv:false,
    repeatPenA:0, repeatPenB:0,
  };

  // --------- Utils ---------
  const el=id=>document.getElementById(id);
  const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
  const rand=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
  const chance=p=>Math.random()<p;
  function log(msg, cls=""){ const p=document.createElement("p"); p.innerHTML=msg; if(cls) p.classList.add(cls); el("log").prepend(p); }

  function setUI(){
    el("scoreA").textContent=S.scoreA;
    el("scoreB").textContent=S.scoreB;
    el("turns").textContent=S.turns;
    el("half").textContent=S.half;
    el("mom").textContent=S.momentum;
    el("sta").textContent=S.stamina;
    el("marker").style.left=S.meters+"%";
    el("pos").textContent=S.poss==='A'?"Your ball":"Opp ball";
    el("posLbl").textContent= S.meters<25?"Your 22": S.meters<50?"Your half": S.meters<75?"Midfield+": "Red Zone";
    el("teamAName").textContent=S.teamA;
    el("teamBName").textContent=S.teamB;

    const disabled = S.lock || S.pendingConv || S.poss!=='A' || S.turns<=0;
    ["btnCrash","btnSwitch","btnChip","btnBox","btnOffload"].forEach(id=>{
      el(id).disabled = disabled || (id==="btnOffload" && !S.canOffload);
    });
  }

  function reset(full=true){
    S.scoreA=0; S.scoreB=0; S.turns=14; S.half=1;
    S.meters=50; S.poss='A'; S.momentum=0; S.stamina=100;
    S.lock=false; S.canOffload=false; S.pendingConv=false;
    S.repeatPenA=0; S.repeatPenB=0;
    if(full){
      S.teamA = el("teamSel").value;
      S.teamB = "Opp";
      S.diff  = el("diffSel").value;
      el("log").innerHTML="";
      log(`<strong>${S.teamA}</strong> receive at midfield. Kickoff!`,"good");
    } else {
      log("Reset to kickoff at midfield.","warn");
    }
    el("convertBox").style.display="none";
    setUI();
  }

  function endTurn(){
    S.turns--;
    if(S.turns===7){
      S.half=2;
      S.meters=50; S.poss='A'; S.momentum=0; S.stamina=100; S.canOffload=false;
      log("<strong>Halftime</strong>. Reset at midfield. Hydrate and go again.","muted");
    }
    if(S.turns<=0){ whistle(); }
  }

  function whistle(){
    S.lock=true;
    setUI();
    const res = S.scoreA===S.scoreB?"Draw":(S.scoreA>S.scoreB?"You Win!":"You Lose");
    log(`<strong>Full time:</strong> ${S.teamA} ${S.scoreA} — ${S.scoreB} ${S.teamB}. <em>${res}</em>`,"good");
  }

  function kickoff(to){
    S.meters=50; S.poss=to; S.momentum=0; S.stamina = to==='A'? clamp(S.stamina+10,0,100): S.stamina;
    S.canOffload=false;
    log(`Kickoff: ${to==='A'?S.teamA:"Opp"} ball at midfield.`,"muted");
    setUI();
  }

  function metersGain(baseMin, baseMax, staminaFactor=1, momFactor=1){
    const staminaMod = (S.stamina-60)/40; // -1..+1 roughly
    const momMod = S.momentum*0.15;
    const raw = Math.random()*(baseMax-baseMin)+baseMin;
    const scaled = raw * (1 + staminaMod*0.15*staminaFactor + momMod*momFactor);
    return Math.round(scaled);
  }

  function penalty(against){ // returns who gets ball & meters
    const sinbinChance = (against==='B'?S.repeatPenB:S.repeatPenA) >=2 ? 0.25 : 0.08;
    const touchMeters = rand(12,28);
    if(against==='B'){ S.repeatPenB++; S.repeatPenA=0; log("Penalty: Opp offside. You kick to touch for territory.","good"); if(chance(sinbinChance)){ log("Yellow card! Opp down to 6 for 2 turns.","good"); S.momentum=clamp(S.momentum+1,-2,2);} S.meters = clamp(S.meters + touchMeters, 0, 100); S.poss='A'; S.canOffload=false; }
    else { S.repeatPenA++; S.repeatPenB=0; log("Penalty: Holding on. Opp kick to touch.","bad"); S.meters = clamp(S.meters - touchMeters, 0, 100); S.poss='B'; S.canOffload=false; }
    setUI();
  }

  function maybeTry(side){
    if(side==='A' && S.meters>=100){ scoreTry('A'); return true; }
    if(side==='B' && S.meters<=0){ scoreTry('B'); return true; }
    return false;
  }

  // Conversion mini-game
  let needlePos=0, needleDir=1, timer=null, sweet={start:42,end:58};
  function showConversion(){
    S.pendingConv=true;
    el("convertBox").style.display="block";
    sweet = {start: 42, end: 58};
    el("sweet").style.left = sweet.start+"%";
    el("sweet").style.width = (sweet.end - sweet.start)+"%";
    needlePos=0; needleDir=1;
    clearInterval(timer);
    timer = setInterval(()=>{
      needlePos += needleDir * 2.2;
      if(needlePos>=100){ needlePos=100; needleDir=-1; }
      if(needlePos<=0){ needlePos=0; needleDir=1; }
      el("needle").style.left = needlePos+"%";
    },18);
  }

  function takeConversion(){
    clearInterval(timer);
    el("convertBox").style.display="none";
    S.pendingConv=false;
    const ok = needlePos>=sweet.start && needlePos<=sweet.end;
    if(ok){ S.scoreA += 2; log("Conversion good (+2).","good"); }
    else { log("Conversion wide.","warn"); }
    kickoff('B'); setUI();
  }

  function scoreTry(side){
    if(side==='A'){
      S.scoreA+=5; log("<strong>TRY!</strong> You dot down in the corner.","good");
      showConversion();
    } else {
      S.scoreB+=5; log("<strong>Opp TRY!</strong> They slice through.","bad");
      // Opp conversion based on difficulty
      const p = S.diff==='casual'?0.6: S.diff==='elite'?0.78:0.7;
      if(Math.random()<p){ S.scoreB+=2; log("Opp conversion good (+2).","warn"); }
      kickoff('A');
    }
    setUI();
  }

  // --------- Your actions ---------
  function doCrash(){
    if(S.lock || S.poss!=='A' || S.pendingConv) return;
    S.lock=true; S.canOffload=false;
    // base risks
    const knockBase = 0.10;
    const penBase   = 0.06; // holding on
    // stamina & momentum influence
    const staminaErr = S.stamina<60 ? (60-S.stamina)/400 : 0; // up to +0.1
    const momAdj = -S.momentum*0.015; // positive momentum reduces error
    // difficulty modifier
    const d = S.diff==='casual'?-0.02: S.diff==='elite'?+0.03:0;

    const knock = Math.random() < (knockBase + staminaErr + d + momAdj);
    const pen = !knock && Math.random() < (penBase + d + (S.momentum<0?0.02:0));
    if(knock){ log("Crash: knock-on in contact.","bad"); S.poss='B'; S.momentum=clamp(S.momentum-1,-2,2); S.stamina=clamp(S.stamina-5,0,100); setUI(); return setTimeout(aiPhase,450); }
    if(pen){ penalty('A'); S.momentum=clamp(S.momentum-1,-2,2); S.stamina=clamp(S.stamina-5,0,100); setUI(); return setTimeout(aiPhase,450); }

    const meters = metersGain(6,15, 1, 1);
    S.meters = clamp(S.meters + meters, 0, 100);
    S.momentum = clamp(S.momentum+1,-2,2);
    S.stamina = clamp(S.stamina-6,0,100);
    log(`Crash: +${meters}m.`,`good`);
    S.canOffload = meters>=10;
    if(!maybeTry('A')){ S.lock=false; endTurn(); setUI(); }
  }

  function doSwitch(){
    if(S.lock || S.poss!=='A' || S.pendingConv) return;
    S.lock=true; S.canOffload=false;
    const fwdBase = 0.14;
    const penBase = 0.04;
    const staminaErr = S.stamina<55 ? (55-S.stamina)/350 : 0;
    const momAdj = -S.momentum*0.02;
    const d = S.diff==='casual'?-0.02: S.diff==='elite'?+0.03:0;

    const fwd = Math.random() < (fwdBase + staminaErr + d + momAdj);
    const pen = !fwd && Math.random() < (penBase + d);
    if(fwd){ log("Switch Pass: forward pass.","bad"); S.poss='B'; S.momentum=clamp(S.momentum-1,-2,2); S.stamina=clamp(S.stamina-5,0,100); setUI(); return setTimeout(aiPhase,450); }
    if(pen){ penalty('A'); S.momentum=clamp(S.momentum-1,-2,2); S.stamina=clamp(S.stamina-5,0,100); setUI(); return setTimeout(aiPhase,450); }

    const meters = metersGain(4,22, 1.1, 1.1);
    S.meters = clamp(S.meters + meters, 0, 100);
    S.momentum = clamp(S.momentum+1,-2,2);
    S.stamina = clamp(S.stamina-7,0,100);
    log(`Switch Pass: +${meters}m.`,`good`);
    S.canOffload = meters>=12;
    if(!maybeTry('A')){ S.lock=false; endTurn(); setUI(); }
  }

  function doChip(){
    if(S.lock || S.poss!=='A' || S.pendingConv) return;
    S.lock=true; S.canOffload=false;
    const reg = Math.random() < (0.26 + S.momentum*0.03 + (S.diff==='casual'?0.04: S.diff==='elite'?-0.03:0));
    const m = Math.round((Math.random()*(34-12)+12) + S.momentum*2);
    S.meters = clamp(S.meters + m, 0, 100);
    S.stamina = clamp(S.stamina-5,0,100);
    if(reg){
      log(`Chip & Chase: regather +${m}m!`,`good`);
      S.momentum = clamp(S.momentum+1,-2,2);
      if(!maybeTry('A')){ S.lock=false; endTurn(); setUI(); }
    } else {
      log(`Chip & Chase: +${m}m territory, but opp gather.`,`warn`);
      S.poss='B'; S.momentum=clamp(S.momentum-1,-2,2);
      setUI(); setTimeout(aiPhase,450);
    }
  }

  function doBox(){
    if(S.lock || S.poss!=='A' || S.pendingConv) return;
    S.lock=true; S.canOffload=false;
    const m = Math.round(Math.random()*(32-16)+16);
    S.meters = clamp(S.meters + m, 0, 100);
    log(`Box kick to touch: +${m}m, lineout to Opp.`,`warn`);
    S.poss='B';
    S.momentum=0; // reset momentum by design
    S.stamina = clamp(S.stamina-3,0,100);
    setUI(); setTimeout(aiPhase,500);
  }

  function doOffload(){
    if(S.lock || S.poss!=='A' || S.pendingConv || !S.canOffload) return;
    S.lock=true; S.canOffload=false;
    const turnover = Math.random() < (0.35 - S.momentum*0.05 + (S.diff==='elite'?0.05:0));
    if(turnover){
      log("Offload attempt spilled — turnover.","bad");
      S.poss='B'; S.momentum=clamp(S.momentum-1,-2,2); S.stamina=clamp(S.stamina-3,0,100);
      setUI(); return setTimeout(aiPhase,450);
    }
    const extra = Math.round((Math.random()*(16-6)+6) + S.momentum*2);
    S.meters = clamp(S.meters + extra, 0, 100);
    log(`Offload sticks! Extra +${extra}m.`,"good");
    S.momentum = clamp(S.momentum+1,-2,2); S.stamina=clamp(S.stamina-3,0,100);
    if(!maybeTry('A')){ S.lock=false; endTurn(); setUI(); }
  }

  // --------- Opponent AI ---------
  function aiPhase(){
    if(S.turns<=0){ whistle(); return; }
    // AI weights by situation
    const behind = S.scoreB < S.scoreA;
    const deepIn = S.meters<20; // near your try
    let choice = "run";
    const r = Math.random();
    if(behind){ choice = r<0.45?"pass":(r<0.75?"run":"kick"); }
    else if(deepIn){ choice = r<0.6?"run":(r<0.8?"pass":"kick"); }
    else { choice = r<0.4?"run":(r<0.7?"pass":"kick"); }

    // difficulty impacts errors for you (above) but for AI we change success rates here
    const diffBoost = S.diff==='elite'?+0.07: S.diff==='casual'?-0.05:0;

    // penalties against opp?
    if(Math.random() < (0.07 - diffBoost + (S.momentum>0?0.02:0))){
      penalty('B'); // Opp offside — your pen
      S.momentum = clamp(S.momentum+1,-2,2);
      S.lock=false; endTurn(); setUI(); return;
    }

    if(choice==="run"){
      const ko = Math.random() < (0.10 - diffBoost);
      if(ko){ log("Opp crash: knock-on. Scrum to you.","good"); S.poss='A'; S.momentum=clamp(S.momentum+1,-2,2); S.lock=false; endTurn(); setUI(); return; }
      const m = Math.round((Math.random()*(15-6)+6) - S.momentum*2);
      S.meters = clamp(S.meters - m, 0, 100);
      log(`Opp crash: -${m}m.`);
    } else if(choice==="pass"){
      const fwd = Math.random() < (0.12 - diffBoost);
      if(fwd){ log("Opp switch: forward pass. Your ball.","good"); S.poss='A'; S.momentum=clamp(S.momentum+1,-2,2); S.lock=false; endTurn(); setUI(); return; }
      const m = Math.round((Math.random()*(20-4)+4) - S.momentum*2);
      S.meters = clamp(S.meters - m, 0, 100);
      log(`Opp switch: -${m}m.`);
    } else {
      const m = Math.round((Math.random()*(32-14)+14) - S.momentum*1);
      const reg = Math.random() < (0.24 + diffBoost);
      S.meters = clamp(S.meters - m, 0, 100);
      if(reg){ log(`Opp chip regather: -${m}m, they keep.`); }
      else { log(`Opp kick to space: -${m}m, your ball back.`,"warn"); S.poss='A'; }
    }

    if(maybeTry('B')){ endTurn(); S.lock=false; setUI(); return; }
    // ruck steal for you
    if(S.poss==='B' && Math.random() < (0.22 + S.momentum*0.06)){ log("Turnover won at ruck!","good"); S.poss='A'; S.momentum=clamp(S.momentum+1,-2,2); }
    S.lock=false; endTurn(); setUI();
  }

  // --------- Wire UI ---------
  el("btnStart").addEventListener("click", ()=>{ reset(true); setUI(); });
  el("btnNew").addEventListener("click", ()=>{ reset(true); });
  el("btnCrash").addEventListener("click", doCrash);
  el("btnSwitch").addEventListener("click", doSwitch);
  el("btnChip").addEventListener("click", doChip);
  el("btnBox").addEventListener("click", doBox);
  el("btnOffload").addEventListener("click", doOffload);
  el("btnKickNow").addEventListener("click", takeConversion);

  // Initial minimal state
  reset(true);
  setUI();
})();
</script>
</body>
</html>
